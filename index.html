<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Man Down Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #resetAlarmBtn {
            background-color: #dc3545;
            display: none;
        }
        #resetAlarmBtn:hover {
            background-color: #c82333;
        }
        #status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .alarm {
            background-color: #dc3545;
            color: white;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Man Down Monitor</h1>
        <div id="status" class="disconnected">Status: Disconnected</div>
        <button id="connectBtn">Connect Device</button>
        <button id="resetAlarmBtn" style="display: none;">Reset Alarm</button>
    </div>

    <script>
        // BLE UUIDs from the Arduino code
        const FALL_SERVICE_UUID = '19b10000-0000-537e-4f6c-d104768a1214';
        const FALL_CHARACTERISTIC_UUID = '19b10000-1111-537e-4f6c-d104768a1214';
        
        let fallCharacteristic = null;
        let device = null;
        let isConnected = false;

        const connectBtn = document.getElementById('connectBtn');
        const resetAlarmBtn = document.getElementById('resetAlarmBtn');
        const statusDiv = document.getElementById('status');

        connectBtn.addEventListener('click', handleConnectionClick);
        resetAlarmBtn.addEventListener('click', resetAlarm);

        async function handleConnectionClick() {
            if (isConnected) {
                await disconnectDevice();
            } else {
                await connectToDevice();
            }
        }

        async function disconnectDevice() {
            if (device && device.gatt.connected) {
                await device.gatt.disconnect();
            }
            handleDisconnection();
        }

        async function connectToDevice() {
            try {
                // Request device with the correct service UUID
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Man Down' }],
                    optionalServices: [FALL_SERVICE_UUID]
                });

                statusDiv.textContent = 'Connecting...';
                
                // Connect to the device
                const server = await device.gatt.connect();
                
                // Get the Fall Detection service
                const service = await server.getPrimaryService(FALL_SERVICE_UUID);
                
                // Get the Fall Alarm characteristic
                fallCharacteristic = await service.getCharacteristic(FALL_CHARACTERISTIC_UUID);

                // Enable notifications
                await fallCharacteristic.startNotifications();
                fallCharacteristic.addEventListener('characteristicvaluechanged', handleAlarmChange);

                // Update UI
                statusDiv.textContent = 'Status: Connected';
                statusDiv.className = 'connected';
                connectBtn.textContent = 'Disconnect';
                isConnected = true;

                // Update connect button to handle disconnect
                device.addEventListener('gattserverdisconnected', handleDisconnection);

            } catch (error) {
                console.error('Error:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                handleDisconnection();
            }
        }

        function handleAlarmChange(event) {
            const value = event.target.value.getUint8(0);
            switch(value) {
                case 0x00:
                    statusDiv.textContent = 'Status: Connected - No Alarm';
                    statusDiv.className = 'connected';
                    resetAlarmBtn.style.display = 'none';
                    break;
                case 0x01:
                    statusDiv.textContent = 'Status: Fall Detected!';
                    statusDiv.className = 'alarm';
                    resetAlarmBtn.style.display = 'block';
                    break;
                case 0x02:
                    statusDiv.textContent = 'Status: ALARM - MAN DOWN!';
                    statusDiv.className = 'alarm';
                    resetAlarmBtn.style.display = 'block';
                    break;
            }
        }

        async function resetAlarm() {
            if (fallCharacteristic && isConnected) {
                try {
                    // Write 0x00 to reset the alarm
                    await fallCharacteristic.writeValue(new Uint8Array([0x00]));
                    statusDiv.textContent = 'Status: Alarm Reset';
                    statusDiv.className = 'connected';
                    resetAlarmBtn.style.display = 'none';
                } catch (error) {
                    console.error('Error resetting alarm:', error);
                    statusDiv.textContent = `Error: ${error.message}`;
                    handleDisconnection();
                }
            }
        }

        function handleDisconnection() {
            statusDiv.textContent = 'Status: Disconnected';
            statusDiv.className = 'disconnected';
            connectBtn.textContent = 'Connect Device';
            resetAlarmBtn.style.display = 'none';
            isConnected = false;
            fallCharacteristic = null;
            device = null;
        }
    </script>
</body>
</html>
