<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Alarm WebApp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }
        button {
            margin: 1em 0;
            padding: 0.5em 1em;
            font-size: 1em;
        }
        #log {
            margin-top: 1em;
            padding: 1em;
            border: 1px solid #ccc;
            background: #f9f9f9;
            height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <h1>Bluetooth Alarm WebApp</h1>
    <button id="connectBtn">Connetti al dispositivo Bluetooth</button>
    <div id="log"></div>

    <script>
        const FALL_DETECTION_SERVICE = "19b10000-0000-537e-4f6c-d104768a1214";
        const FALL_ALARM_CHARACTERISTIC = "19b10000-1111-537e-4f6c-d104768a1214";
        const BATTERY_SERVICE = "0000180f-0000-1000-8000-00805f9b34fb"; // UUID completo del Battery Service
        const BATTERY_CHARACTERISTIC = "2a19";

        const log = (message) => {
            const logDiv = document.getElementById('log');
            logDiv.textContent += `${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                log('Richiesta di connessione al dispositivo Bluetooth in corso...');

                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: false,
                    optionalServices: [FALL_DETECTION_SERVICE, BATTERY_SERVICE],
                    filters: [{ services: [FALL_DETECTION_SERVICE] }]
                });

                log(`Dispositivo selezionato: ${device.name}`);

                const server = await device.gatt.connect();
                log('Connessione al GATT server riuscita.');

                const fallService = await server.getPrimaryService(FALL_DETECTION_SERVICE);
                const fallCharacteristic = await fallService.getCharacteristic(FALL_ALARM_CHARACTERISTIC);
                
                fallCharacteristic.startNotifications();
                log('Sottoscrizione alle notifiche degli allarmi in corso...');

                fallCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = new Uint8Array(event.target.value.buffer);
                    log(`Allarme ricevuto: ${value}`);
                });

                const batteryService = await server.getPrimaryService(BATTERY_SERVICE);
                const batteryCharacteristic = await batteryService.getCharacteristic(BATTERY_CHARACTERISTIC);
                const batteryValue = await batteryCharacteristic.readValue();
                const batteryLevel = batteryValue.getUint8(0);
                log(`Livello batteria: ${batteryLevel}%`);

            } catch (error) {
                log(`Errore: ${error.message}`);
            }
        });
    </script>
</body>
</html>
